NUM_NODES = 3
IP_BASE = "192.168.0."
SSH_PUBLIC_KEY_PATH = File.expand_path("~/.ssh/id_rsa.pub")

Vagrant.configure("2") do |config|
  (1..NUM_NODES).each do |i|
    hostname = "k8s-node%02d" % i
    ip = IP_BASE + (90 + i).to_s

    config.vm.define hostname do |nodeconfig|
      nodeconfig.vm.box = "rockylinux/9"
      nodeconfig.vm.hostname = hostname

      # Desativa pastas sincronizadas padrão
      nodeconfig.vm.synced_folder ".", "/vagrant", disabled: true

      nodeconfig.ssh.username = 'vagrant'
      nodeconfig.ssh.insert_key = false

      # Rede com IP fixo em modo bridge
      nodeconfig.vm.network "public_network", bridge: ["enp60s0"], ip: ip

      # Recursos da VM
      nodeconfig.vm.provider "virtualbox" do |v|
        v.memory = 4096
        v.cpus = 4

        # Configurações gráficas otimizadas
        v.customize ["modifyvm", :id, "--vram", "128"]
        v.customize ["modifyvm", :id, "--graphicscontroller", "vmsvga"]
        v.customize ["modifyvm", :id, "--accelerate3d", "on"]
      end

      # Copia a chave pública para dentro da VM
      nodeconfig.vm.provision "file", source: SSH_PUBLIC_KEY_PATH, destination: "/home/vagrant/.ssh/id_rsa.pub"

      # Script de provisionamento principal
      nodeconfig.vm.provision "shell", inline: <<-SHELL
        set -e

        echo "Configurando SSH..."
        mkdir -p /home/vagrant/.ssh
        cat /home/vagrant/.ssh/id_rsa.pub >> /home/vagrant/.ssh/authorized_keys
        chmod 600 /home/vagrant/.ssh/authorized_keys
        chown -R vagrant:vagrant /home/vagrant/.ssh

        echo "Atualizando sistema e kernel..."
        dnf update -y

        echo "Instalando dependências para Guest Additions..."
        dnf install -y kernel kernel-devel kernel-headers gcc make perl elfutils-libelf-devel bzip2

        echo "Instalação concluída. Reboot necessário para usar novo kernel."
        shutdown -r now
      SHELL
    end
  end
end
